
<!DOCTYPE html>
<html>
<head>
<script src="assets/js/jquery-1.11.2.min.js"></script>
<link rel="stylesheet" href="assets/css/jquery-ui.css">
  <script src="assets/js/jquery-ui.js"></script>
  <script src="assets/js/jquery.ui.touch-punch.min.js"></script>
  <link rel="stylesheet" href="assets/css/bootstrap.min.css"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <link rel="assets/js/style.css">
  <script>
  $(function() {
    $( "#durationSlider" ).slider({
      min: 0,
      max: 2000,
      value: 1000,
      slide: function( event, ui ) {
        $( "#durationValue" ).val( ui.value + ' ms');
      }
    });
    $( "#durationValue" ).val( $( "#durationSlider" ).slider( "value" ) + ' ms');

    $( "#positionSlider" ).slider({
      min: 0,
      max: 100,
      value: 50,
      slide: function( event, ui ) {
        $( "#positionValue" ).val( ui.value + ' ms');
      }

    });
  });
  </script>



  <style>
      .actuatorCommand { width: 71px; height: 71px; position: absolute;}
      #actuatorCommand .ui-selected { background: #F39814; color: white; }
      .trackCreationHint { pointer-events: none; width: 4px; height: 71px; position: absolute; background-color: gray; opacity: .5; }
      .actuatorTrack { width: 90%; height:80px; float:right; border:2px solid #ccc; padding: 2px; }
      h3 { clear: left; }
  </style>

  <script>

    var selectedCmdID = null;
    var trackLists = {};
    var trackIDs = {};
    var idToCmdMap = {};

    var trackCreationHint = $("<div></div>", {
        class: 'trackCreationHint',
        id: 'trackCreationHint',
        style: 'display: none;'
    });

  function setselectedCmdID(commandID)
  {
    if( selectedCmdID !== null && selectedCmdID !== undefined ){

        console.log('deselecting ' + selectedCmdID);
        $('#' + selectedCmdID.id + '_closeButton').css('display', 'none');
    }
    selectedCmdID = commandID;

    if( selectedCmdID !== null && selectedCmdID !== undefined ){

        data = idToCmdMap[selectedCmdID];

        console.log('data: ' + JSON.stringify(data));


        $('#actuatorType').val(data.addr);
        $('#delay').val(data.delay);
        $('#loop').val(data.loop);
        $('#durationSlider').slider( "value", data.setPoints[0] );
        $('#positionSlider').slider( "value", data.setPoints[1] / 65535 );
    }
  }

  function addTrackItem( newID, trackType, trackEntries, event ) {
        console.log("addTrackItem");

        var newObj = $("<div></div>", {
            class: 'actuatorCommand ui-widget-content',
            id: newID,
        });

        var trackObj = $('#' + trackType + 'Track');
        trackObj.append(newObj);

        newObj.css('left', trackCreationHint.position().left + 'px');
        newObj.append('<button id="' + newID + '_closeButton"; style="float:right">x</button><h3>' + newID + '</h3>');

        newObj.draggable({ containment: '#' + trackType + 'Track', scroll: false, axis: "x" });
        newObj.selectable();
        trackEntries[trackEntries.length] = newObj;

        var loopVal = 1;
        if( trackType == 'Purr' )
        {
            loopVal = 65535;
        }

        idToCmdMap[newID] = {
            "addr":trackType.toLowerCase(),
            "delay":0,
            "loop":loopVal,
            "setPoints":[1000,0]
        };

        newObj.mouseenter(function( event ) {
            event.stopPropagation();
            console.log(this.id + ' enter event');
            $('#' + this.id + '_closeButton').css('display', 'block ');
            trackCreationHint.css("display", "none");
            trackCreationHint.remove();
        });

        newObj.mouseleave(function( event ) {
            event.stopPropagation();
            console.log(this.id + ' leave event');

            if( selectedCmdID != this )
            {
                $('#' + this.id + '_closeButton').css('display', 'none');
            }
        });

        newObj.click(function( event ) {
            event.stopPropagation();

            setselectedCmdID(this.id);
            var index = trackEntries.indexOf(newObj);

            $('#' + this.id + '_closeButton').css('display', 'block ');
            console.log(this.id + " clicked, trackEntries.length: " + trackEntries.length + ", index: " + index);
        });

        newObj.on('click', '#' + newID + '_closeButton', function( event ) {
            event.stopPropagation();

            var index = trackEntries.indexOf(newObj);

            console.log(this.id + " x clicked");


            if (index > -1) {
                trackEntries.splice(index, 1);
                newObj.remove();
            }
        });


        setselectedCmdID(newObj.id);


        console.log("trackEntries.length: " + trackEntries.length + ", index of " + newID + ": " + trackEntries.indexOf(newObj));
  }

  $(function() {
    $(".actuatorTrack").click(function( event ) {
            
        var name = $(this).attr('name');

        if( trackCreationHint.css('display') != 'none' )
        {
                        
            if( !(name in trackIDs ) )
            {
                trackIDs[name] = 1;
            }

            if( !(name in trackLists ) )
            {
                trackLists[name] = [];
            }

            var newID = name + trackIDs[name]++;

            console.log('name: ' + name + ', newID: ' + newID + ", trackIDs[name]: " + trackIDs[name])

            addTrackItem( newID, name, trackLists[name], event);
            trackCreationHint.css("display", "none");
            trackCreationHint.remove();
        }
    });
  });


    $(function(){
        $( ".actuatorTrack" ).mouseenter(
          function() {
            //console.log("mouseenter in actuatorTrack");

            event.stopPropagation();
          }

        );

        $( ".actuatorTrack" ).mousemove(
          function() {
            //console.log("mousemove in actuatorTrack");

            var trackObj = $(this);
            var width = trackCreationHint.width();
            var leftBound = trackObj.position().left + parseInt(trackObj.css('padding'));
            var rightBound = leftBound + trackObj.width() - width;

            var name = $(this).attr('name');
            var spaceToAdd = true;

            if( name in trackLists )
            {
                var leftOfMouse = -1;
                var rightOfMouse = 99999;
                leftOfMouseIndex = -1;
                rightOfMouseIndex = -1;
                spaceToAdd = false; //assume no space if any items in the track.
                //now see if we are hovering over a spot with enough room to add:
                for (var i = 0; i < trackLists[name].length; i++) {
                    var temp = trackLists[name][i];
                    var tempLeft = temp.position().left;
                    var tempRight = temp.position().right;

                    if( temp.position().left + temp.width() < event.clientX && temp.position().left + temp.width() > leftOfMouse ) {
                        leftOfMouse = temp.position().left + temp.width();
                        leftOfMouseIndex = i;
                    }

                    if( temp.position().left > event.clientX && temp.position().left < rightOfMouse ) {
                        rightOfMouse = temp.position().left;
                        rightOfMouseIndex = i;
                    }
                };

                if( leftOfMouseIndex >= 0 ) {
                    leftBound = leftOfMouse;
                }

                if( rightOfMouseIndex >= 0 ) {
                    rightBound = rightOfMouse;
                }
            }

            $(this).append(trackCreationHint);
            trackCreationHint.css("display", "block");

            var newX = Math.max( leftBound, ( event.clientX - width / 2 ))
            newX = Math.min( rightBound, newX);



            // console.log('event.clientX: ' + event.clientX + ', leftBound: ' + leftBound + ', rightBound: ' + rightBound);

            trackCreationHint.css("left", newX + "px");
//            trackCreationHint.width(rightBound-leftBound);


            if( trackCreationHint.position().left - trackCreationHint.width() / 2 <= leftBound || trackCreationHint.position().left + trackCreationHint.width() >= rightBound ) {
//                trackCreationHint.css("display", "none");
//                trackCreationHint.remove();
            }

          }

        );

        $( ".actuatorTrack" ).mouseleave(
          function() {
            //console.log("mouseleave in actuatorTrack");
            trackCreationHint.css("display", "none");
            trackCreationHint.remove();
          }
        );


    });


    $(function(){
        $( "#behaviourEditorPlayButton" ).click(
          function() {
            var setPoints = [];
            setPoints[0] = $( "#durationSlider" ).slider( "value" );
            setPoints[1] = Math.round( 65535 * $( "#positionSlider" ).slider( "value" ) / 100 )

            $( "#behaviourEditorPlayButton" ).prop('disabled',true);
                $( "#behaviourEditorPlayButton" ).text("Playing...");
            setTimeout(function(){
                console.log("BUTTON DONE");
                $( "#behaviourEditorPlayButton" ).prop('disabled',false);
                $( "#behaviourEditorPlayButton" ).text("Play");
            }, setPoints[0]);

            sendSetPointCommand($( "#actuatorType" ).val(), $( "#delay" ).val(), $( "#loop" ).val(), setPoints)
          }

        );
    });


    $(function(){
        $( "#tracksPlayButton" ).click(
          function() {
            currBehaviour = getBehaviourJSON();
            console.log(JSON.stringify(currBehaviour,null,4));

            if( currBehaviour.length > 0 ){
                setTimeout(waitAndSendNextCommand(currBehaviour,0), currBehaviour[0].delayAfterPrevCmd);
            }
          }
        );
    });

    function waitAndSendNextCommand( behaviour, currIndex )
    {
        if( currIndex < behaviour.length ){
            
            console.log('waitAndSendNextCommand, sending: ' + behaviour[currIndex]);

            //sendSetPointCommand(behaviour[currIndex].addr, behaviour[currIndex].delay, behaviour[currIndex].loop, behaviour[currIndex].setPoints)
            setTimeout(waitAndSendNextCommand(behaviour, currIndex++), behaviour[currIndex].delayAfterPrevCmd);
        }
    }

    function getBehaviourJSON()
    {
        var tracks = $('.actuatorTrack');

        var list = tracks.find('.actuatorCommand');
        var sortedList = list.sort(function (a, b) {
            aPos = $('#' + a.id).position().left;
            bPos = $('#' + b.id).position().left;
            return +aPos - +bPos;
        });


        var cmdList = [];
        var prevCmdTime = 0;

        for( var i = 0; i < sortedList.length; i++ )
        {
            var data = idToCmdMap[sortedList[i].id];
            var currTime = $('#' + sortedList[i].id).position().left;
            data.delayAfterPrevCmd = currTime - prevCmdTime;
            cmdList[i] = data;
            prevCmdTime = currTime;
        }

        return cmdList;
    }

    function sendSetPointCommand(address, delay, loop, setPoints) {

        console.log("addr: " + address + ", delay: " + delay + ", loop: " + loop + ", setPoints: " + setPoints);
        console.log("json: " + JSON.stringify({"addr" : address, "delay" : delay, "loop" : loop, "setPoints" : setPoints}))

        $.ajax
        ({
            type: "POST",
            //the url where you want to sent the userName and password to
            url: location.href + 'setpoint',
            dataType: 'json',
            async: true,
            //json object to sent to the authentication url
            data: JSON.stringify({"addr" : address, "delay" : delay, "loop" : loop, "setPoints" : setPoints}),
            success: function () {
                console.log('successfully sent setpoint command, data: ' + data);
            }
        })
    };
    </script>
</head>
<body>
    <div id="BehaviourEditor" style='border:2px solid #ccc; width:19%; height:50%; float:left; padding: 5px'>
        <h2>Behaviour Editor</h2>
        <p>
            <label for="actuatorType">Actuator:</label>
            <input type="text" id="actuatorType" style="color:#f6931f; font-weight:bold;">
        </p>
        <p>
            <label for="delay">Delay:</label>
            <input type="number" id="delay" style="color:#f6931f; font-weight:bold;">
        </p>
        <p>
            <label for="loop">Loop:</label>
            <input type="number" id="loop" style="color:#f6931f; font-weight:bold;">
        </p>
        <p>Position</p>
        <div id="positionSlider"></div>
        <p>
            <label for="durationValue">Duration:</label>
            <input type="text" id="durationValue" readonly style="border:0; color:#f6931f; font-weight:bold;">
        </p>
        <div id="durationSlider"></div>
        <p>
            <button id="behaviourEditorPlayButton" class="btn" style='width:100px; height:50px'>Play</button>
        </p>
    </div>
    <div id="BehaviourTracks" style='width:80%; float:right'>
        <div style='width:8%; float:left'>
            <p>
                <button id="tracksPlayButton" class='btn' style='width:100%; height:50px'>Play</button>
            </p>
        </div>

        <div id="PurrTrack" name='Purr' class='actuatorTrack'></div>

        <div id="RibsTrack" name='Ribs' class='actuatorTrack'></div>
        
        <div id="HeadXTrack" name='HeadX' class='actuatorTrack'></div>
        
        <div id="HeadYTrack" name='HeadY' class='actuatorTrack'></div>
        
        <div id="SpineTrack" name='Spine' class='actuatorTrack'></div>
    </div>

</body>
</html>

